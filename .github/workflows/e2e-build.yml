


name: Build End-to-End Test Artifacts
env:
    OPERATOR_GITHUB_REPO_NAME: "aws/amazon-cloudwatch-agent-operator"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true
on:
    push:
        branches:
            - e2c-build-workflow
    workflow_dispatch:
        inputs:
            operator-branch:
                required: true
                type: string
                default: 'main'
            agent-branch:
                required: true
                type: string
                default: 'main'
    workflow_call:
        inputs:
            operator-branch:
                required: true
                type: string
                default: 'main'
            agent-branch:
                required: true
                type: string
                default: ${{github.ref_name}}

jobs:
    GetLatestCommitSHAs:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout the target repo
            uses: actions/checkout@v3
            with:
                repository: ${{env.OPERATOR_GITHUB_REPO_NAME}} 
                ref: ${{inputs.operator-branch}}    
                path: operator-repo  

          - name: Get latest commit SHA
            id: get_latest_sha
            run: |
                    cd operator-repo
                    latest_sha=$(git rev-parse HEAD)
                    echo "::set-output name=LATEST_SHA::$latest_sha"
    BuildAgent:
        uses: ./.github/workflows/build-test-artifacts.yml
        secrets: inherit
        concurrency:
            group: ${{ github.workflow }}-${{inputs.agent-branch}}
            cancel-in-progress: true
        permissions:
          id-token: write
          contents: read
    BuildOperator:
        needs: [GetLatestCommitSHAs]
        uses: aws/amazon-cloudwatch-agent-operator/.github/workflows/build-and-upload-release.yml@main
        secrets: inherit
        with:
            tag: ${{needs.GetLatestCommitSHAs.outputs.LATEST_SHA}}


